{"name":"Bitrix Migration (BIM)","tagline":"Bitrix, bim, migration, db","body":"# <a name=\"about\"></a>Bitrix Migration (BIM)\r\n\r\n[![Latest Stable Version](https://poser.pugx.org/cjp2600/bim-core/v/stable.svg)](https://packagist.org/packages/cjp2600/bim-core) [![Total Downloads](https://poser.pugx.org/cjp2600/bim-core/downloads.svg)](https://packagist.org/packages/cjp2600/bim-core) [![Latest Unstable Version](https://poser.pugx.org/cjp2600/bim-core/v/unstable.svg)](https://packagist.org/packages/cjp2600/bim-core) [![License](https://poser.pugx.org/cjp2600/bim-core/license.svg)](https://packagist.org/packages/cjp2600/bim-core)\r\n\r\nВерсионная миграция структуры БД для **[1С Битрикс CMS](http://bitrix.ru)**\r\n\r\n- [Установка](#install)\r\n  * [Автоматическая установка](#auto)\r\n  * [Ручная установка](#hand)\r\n- [Настройка](#prop)\r\n- [Выполнение - bim up](#up)\r\n- [Отмена - bim down](#down)\r\n- [Вывод списка - bim ls](#ls)\r\n- [Создание - bim gen](#gen)\r\n  * [Создание пустой миграции](#gen_empty)\r\n  * [Создание миграционного кода по наличию](#gen_nal)\r\n    * [IblockType](#iblocktype)\r\n    * [Iblock](#iblock)\r\n    * [IblockProperty](#iblockproperty)\r\n    * [Highloadblock](#hlblock)\r\n\r\n# <a name=\"install\"></a>1 Установка\r\n\r\n### <a name=\"auto\"></a>1.1 Автоматическая установка \r\n\r\nДля установки и инициализации bim для bitrix проекта необходимо выполнить следующиие действия из корня проекта:\r\n\r\n- Установить Composer:\r\n```    \r\ncurl -s https://getcomposer.org/installer | php\r\n```\r\n- Выполнить установочный скрипт:\r\n\r\n``` bash\r\nphp -r \"readfile('https://raw.githubusercontent.com/cjp2600/bim/master/install');\" | php\r\n```\r\n> Автоматические действия установщика:\r\n\r\n> 1. Добавление файла **bim** в корень проекта.\r\n> 2. Инициализация **composer autoloader** в файле **init.php**\r\n> 3. Создание файла **composer.json** в корне проекта со ссылкой на **bim** репозиторий **\"require\": { \"cjp2600/bim-core\": \"dev-master\"}**\r\n\r\n### <a name=\"hand\"></a>1.2 Ручная установка \r\n\r\nДля ручной установки bim необходимо:\r\n\r\n- Установить Composer:\r\n   \r\n```    \r\ncurl -s https://getcomposer.org/installer | php\r\n```\r\n\r\n- Создать файл bim (без расширения) в корне bitrix проекта с содержимым:\r\n```php\r\n#!/usr/bin/php\r\n<?php\r\n\r\nini_set('max_execution_time', 36000);\r\n\r\ndefine(\"NO_KEEP_STATISTIC\", true);\r\ndefine(\"NO_AGENT_STATISTIC\", true);\r\ndefine(\"NOT_CHECK_PERMISSIONS\", true);\r\n$_SERVER[\"DOCUMENT_ROOT\"] = dirname(__FILE__);\r\nrequire($_SERVER[\"DOCUMENT_ROOT\"] . \"/bitrix/modules/main/include/prolog_before.php\");\r\n\r\n\\Bim\\Migration::init();\r\n\r\n```\r\n- Добавть инициализацию composer (в файл init.php добавить запись):\r\n\r\n```bash\r\nif (file_exists($_SERVER['DOCUMENT_ROOT'] . '/vendor/autoload.php'))\r\n    require_once $_SERVER['DOCUMENT_ROOT'] . '/vendor/autoload.php';\r\n```\r\n\r\n- Создать в корне сайта файл **composer.json** с содержимым:\r\n\r\n```json\r\n{\r\n\t\"require\": {\r\n\t\t\"cjp2600/bim-core\": \"dev-master\"\r\n\t}\r\n}\r\n```\r\n\r\n- В **.gitignore** добавить запись:\r\n\r\n```\r\n/vendor\r\n*.lock\r\n```\r\n\r\n\r\n# 2 <a name=\"prop\"></a>Настройка\r\n\r\nДля начала работы обновляем **composer** и создаем миграционную таблицу в БД:\r\n\r\n``` bash\r\nphp composer.phar update\r\n```\r\nСоздаём таблицу миграций : \r\n\r\n```bash\r\nphp bim init\r\n```\r\n\r\n\r\n# 3 <a name=\"up\"></a>Выполнение миграций [BIM UP]\r\n\r\n- Общее выполнение:\r\n```bash\r\nphp bim up\r\n```\r\nВыполняет полный список не выполненых либо ранее отмененных миграционных классов отсортированых по названию (**timestamp**).\r\n\r\n- Еденичное выполнение:\r\n```bash\r\nphp bim up 1423660766\r\n```\r\nВыполняет указанную в праметрах миграцию.\r\n\r\n- Выполнение по временному периоду:\r\n```bash\r\nphp bim up --from=\"29.01.2015 00:01\" --to=\"29.01.2015 23:55\"\r\n```\r\n- Выполнение по тегу:\r\n```bash\r\nphp bim up --tag=iws-123\r\n```\r\nВыполняет все миграции где найден указанный тег в описании.\r\n\r\nНапример:\r\n\r\n> Description: add new migration #iws-123\r\n\r\n\r\n# 4 <a name=\"down\"></a>Отмена выполненых миграций  [BIM DOWN]\r\n\r\n- Общая отмена:\r\n```bash\r\nphp bim down\r\n```\r\nОтменяет весь список выполненных миграционных классов.\r\n\r\n- Еденичная отмена:\r\n``` bash\r\nphp bim down 1423660766\r\n```\r\nОтменяет указанную в праметрах миграцию.\r\n\r\n- Отмена по временному периоду:\r\n```bash\r\nphp bim down --from=\"29.01.2015 00:01\" --to=\"29.01.2015 23:55\"\r\n```\r\n- Отмена по тегу:\r\n```bash\r\nphp bim up --tag=iws-123\r\n```\r\nОтменяет все миграции где найден указанный тег в описании.\r\n\r\nНапример:\r\n> Description: add new migration #iws-123\r\n\r\n# 5 <a name=\"ls\"></a>Вывод списка миграций [BIM LS]\r\n- Общей список:\r\n```bash\r\nphp bim ls\r\n```\r\n- Список выполненных миграций:\r\n```bash\r\nphp bim ls --a\r\n```\r\n- Список отменённых миграций:\r\n```bash\r\nphp bim ls --n\r\n```\r\n- Список миграций за определённый период времени:\r\n```bash\r\nphp bim ls --from=\"29.01.2015 00:01\" --to=\"29.01.2015 23:55\" \r\n```\r\n- Список миграций по тегу:\r\n```bash\r\nphp bim ls --tag=iws-123\r\n```\r\n\r\n# 6 <a name=\"gen\"></a>Создание новых миграций [BIM GEN]\r\n\r\nСуществует два способа создания миграций:\r\n \r\n## <a name=\"gen_empty\"></a>1) Создание пустой миграции:\r\nСоздается пустой шаблон миграционного класса. Структура класса определена интерфейсом *Bim/Revision* и включает следующие\r\nобязательные методы:\r\n \r\n  - *up();* - выполнение\r\n  - *down();* - отмена\r\n  - *getDescription();* - получения описания.\r\n  - *getAuthor();* - получение автора.\r\n\r\nДополнительно запрашивается:\r\n- [Description]\r\n \r\n**Пример:**\r\n\r\n``` bash\r\nphp bim gen\r\n```\r\nТакже возможно передать description опционально:\r\n``` bash  \r\nphp bim gen --d=\"new description #iws-123\"\r\n```\r\n\r\n> Далее создается файл миграции вида: */[migrations_path]/[timestamp].php\r\n\r\n> Например: /migrations/123412434.php\r\n \r\n## <a name=\"gen_nal\"></a>2) Создание миграционного кода по наличию:\r\n\r\nСоздается код развертывания/отката существующего элемента схемы bitrix БД.\r\nНа данный момент доступно генерация по наличию для следующих элементов bitrix БД:\r\n \r\n### 2.1 <a name=\"iblocktype\"></a>IblockType *( php bim gen IblockType:[add|delete] )*:\r\n\r\nСоздается Миграционный код \"**Типа ИБ**\" включая созданные для него *(UserFields, IBlock, IblockProperty)*\r\n \r\nДополнительно запрашивается:\r\n- [IBLOCK_TYPE_ID]\r\n- [Description]\r\n \r\n**Пример:**\r\n\r\n``` bash \r\nphp bim gen IblockType:add\r\n``` \r\nТакже возможно передать iblock type id и description опционально:\r\n``` bash  \r\nphp bim gen IblockType:add --typeId=catalog --d=\"new description #iws-123\"\r\n``` \r\n### <a name=\"iblock\"></a>2.2 Iblock *( php bim gen Iblock:[add|delete] )*:\r\n\r\nСоздается Миграционный код \"**ИБ**\" включая созданные для него *(IblockProperty)*\r\n\r\nДополнительно запрашивается:\r\n- [IBLOCK_CODE]\r\n- [Description]\r\n\r\n**Пример:**\r\n``` bash  \r\nphp bim gen Iblock:add\r\n``` \r\nТакже возможно передать iblock code и description опционально:\r\n``` bash  \r\nphp bim gen Iblock:add --code=goods --d=\"new description #iws-123\"\r\n``` \r\n\r\n### <a name=\"iblockproperty\"></a>2.3 IblockProperty *( php bim gen IblockProperty:[add|delete] )*:\r\n\r\nСоздается Миграционный код \"**Свойства ИБ**\"\r\n\r\nДополнительно запрашивается:\r\n- [IBLOCK_CODE]\r\n- [PROPERTY_CODE]\r\n- [Description]\r\n\r\n**Пример:**\r\n``` bash  \r\nphp bim gen IblockProperty:add\r\n``` \r\nТакже возможно передать iblock code, property code и description опционально:\r\n``` bash  \r\nphp bim gen IblockProperty:add --code=goods --propertyCode=NEW_ITEM --d=\"new description #iws-123\"\r\n``` \r\n\r\n### <a name=\"hlblock\"></a>2.4 Hlblock *( php bim gen Hlblock:[add|delete] )*:\r\n\r\nСоздается Миграционный код \"**Highloadblock**\" включая созданные для него *(UserFields)*\r\n\r\nДополнительно запрашивается:\r\n- [HLBLOCK_ID]\r\n- [Description]\r\n\r\n**Пример:**\r\n``` bash  \r\nphp bim gen Hlblock:add\r\n``` \r\nТакже возможно передать hlblock id и description опционально:\r\n``` bash  \r\nphp bim gen IHlblock:add --id=82 --d=\"new description #iws-123\"\r\n``` \r\n\r\n\r\n\r\n> Обратите внимание!\r\n\r\n> что миграционные классы созданные по наличию, выполняются автоматически.\r\n \r\n","google":"","note":"Don't delete this file! It's used internally to help with page regeneration."}